<!DOCTYPE html>
<html lang="en">

	<head>
        {% load static %}
		<meta charset="utf-8">
		<title>TiMi</title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
		<!-- Demo css -->
		<link rel="stylesheet" href="{% static "css/bootstrap.min.css"  %}">
		<link rel="stylesheet" href="{% static "css/font-awesome.min.css"  %}">
		<!--Link Swiper's CSS-->
		<link rel="stylesheet" href="{% static "css/swiper-3.4.2.min.css"  %}">
		<!--styles-->
		<link rel="stylesheet" href="{% static "css/swiper-menu.css"  %}">
		<link rel="stylesheet" href="{% static "css/autoop-index.css"  %}">

		<!-- 动态加载 -->
		<link rel="stylesheet" href="{% static "css/autoop-zkym.css"  %}">
		<link rel="stylesheet" type="text/css" href="{% static "css/all-page.css"  %}"/>

	</head>

	<body background="{% static "img/background.jpg" %}">

		<!-- modal-overlay -->

		<div class="modal-alert">
			<h4></h4>
		</div>

		<!-- Swiper -->
		<div class="swiper-container">
			<div class="swiper-wrapper">

				<div class="swiper-slide menu">

					<div class="index-menu col-sm-9 col-xs-11">
						<div class="index-menu-home">
							<a href="{% url 'user:index' %}">
								<h1>TiMi</h1></a>
						</div>
						<ul class="index-menu-nav">
							<li>
								<a href="{% url 'user:index' %}">
									<!--<span class="first fa fa-laptop"></span>-->
									<span class="first fa fa-cny"></span>
									<span class="text">用户信息</span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>
							<li>
								<a href="{% url 'user:addputer' %}">
									<span class="first fa fa-bar-chart"></span>
									<span class="text">添加主机</span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>
							<li>
								<a href="{% url 'user:addapp' %}">
									<span class="first fa fa-cny"></span>
									<span class="text">部署管理</span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>
							<li id="active">
								<a href="{% url 'user:putermage' %}">
									<span class="first fa fa-sitemap"></span>
									<span class="text">主机信息</span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>
							<li>
								<a href="{% url 'user:remotquery' %}">
									<span class="first fa fa-dashboard"></span>
									<span class="text">远程查询</span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>
							<!--<li>
								<a href="">
									<span class="first fa fa-book"></span>
									<span class="text"></span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>
							<li>
								<a href="">
									<span class="first fa fa-book"></span>
									<span class="text"></span>
									<span class="card">
                                    <i class="front fa fa-angle-left"></i>
                                    <i class="back"></i>
                                </span>
								</a>
							</li>-->
						</ul>
					</div>

				</div>


            <div class="content">
                <div class=" col-sm-12 col-xs-12">
                    <div class="index-main-top">
                        <div class="menu-button">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                        <h2 class="index-main-top-nav">TiMi&emsp;<i class="fa fa-angle-right"></i>&emsp;<span>详细信息</span></h2>
                        <div class="index-main-top-signout">
                                {% if request.user.id %}
                                    <span>欢迎您：{{ request.user.username }}</span>
                                    <div style="float: right">
                                        <a href="{% url 'user:logout' %}"><span>注销</span ></a>
                                    </div>
                                {% else %}
                                     <a href="{% url 'user:login' %}"><span class="fa">&#xf007;&emsp;</span>登陆</a>
                                {% endif %}
                        </div>
                    </div>
                    <div class="index-main-contain my-back">

                        <!-- contain -->
                        <div class="">
                            <div class="" style="width: auto;">
                            	<h3>远程主机连接状态分布表</h3>
                            </div>
                            <div class="add-log">
                            	<div class="contain-header">
                                    <div id="show" style="line-height: 50px;position: fixed"></div>
	                                <h3>
                                        <b style="text-align: center">主机状态</b>
                                    </h3>
                            	</div>

                            <!-- table -->
                            	<div class="theTable">
                                <table class="table table-striped table-bordered table-hover">

									<thead>
	                                    <tr style="font-size: 10px">
											<th>序号</th>
	                                        <th>主机名</th>
	                                        <th>IP地址</th>
	                                        <th>端口</th>
	                                        <th>ssh用户名</th>
	                                        <th>操作系统</th>
	                                        <th>ssh远程状态</th>
	                                        <th>mac地址</th>
	                                        <th id="res_frememery">可用内存(MB)</th>
	                                        <th id="res_allmemery">总内存(MB)</th>
	                                        <th>内存状态</th>
	                                        <th>操作</th>
	                                    </tr>
	                                </thead>
	                                <tbody  id="com-mage">


                                    <tr style="display: none">
                                        <td>0</td>
                                        <td>1</td>
                                        <td>2</td>
                                        <td>3</td>
                                        <td>4</td>
                                        <td>5</td>
                                        <td>6</td>
                                        <td>7</td>
                                        <td>8</td>
                                        <td>



                                        	<div style="height: 50px;width: 400px;border: 1px solid black">
												<div  id="show_random_temp" style="height: 100%; background-color: rgba(56,156,182,1);line-height: 50px"></div>
											</div>

                                        </td>
                                        <td> 
                                            <a href="C-add-this.html" title="部署管理" class="fa"><span class="fa-sitemap">安装</span></a> 
                                        </td>
                                    </tr>




                                  	<!--<tr>
                                        	<td>
                                        		<div>
                                        			<div id="show" style="display: none;"></div>
													<div ></div>
													<strong id="show_random_num"></strong>
													<div style="height: 50px;width: 400px;border: 1px solid black">
														<div  id="show_random" style="height: 100%; background-color: green;line-height: 50px"></div>
													</div>
                                        		</div>
                                        	</td>
                                     </tr>-->

                                </tbody>
                            	</table>
                            </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
	<!--显示内存状态：-->
	<!--<div id="dv1"></div>-->
	<!--<textarea name="" id="chat-log" cols="30" rows="10"></textarea>-->

	<!--<input id="aaa" type="button" value="发送">-->


    <script src="{% static 'js/jquery-2.2.3.min.js'  %}"></script>
    <script src="{% static 'js/bootstrap.min.js'  %}"></script>
    <script type="text/javascript">
		//设置一个时钟
        window.onload = function() {
		var show = document.getElementById("show");
		var show1 = document.getElementById("show_random_temp");
		setInterval(function() {
		var time = new Date();   // 程序计时的月从0开始取值后+1
		var m = time.getMonth() + 1;
		var t = time.getFullYear() + "-" + m + "-"
		+ time.getDate() + " " + time.getHours() + ":"
		+ time.getMinutes() + ":" + time.getSeconds();
		//设置当前时间
		show.innerHTML = '当前时间：'+ t　;
		var num=getRandom(50,100)/100.00 *100;
		num=num.toFixed(2)
		show1.style.width =num + '%';
		show1.innerHTML=num + '%';
//		show2.innerHTML="当前内存使用状态："+num + '%';

		}, 1000);
		};


		function getRandom(n,m){
		        var n=Number(n);    //强制转换成数字
		        var m=Number(m);
		        if(isNaN(n)||isNaN(m)){    //判断是否为有效数字 ，其中一个不是有效数字就返回[0,1)之间的随机小数
		            return math.random();
		        }
		        if(n>m){     //如果n>m则交换
		            var temp=n;
		            n=m;
		            m=temp;
		        }
		        return Math.round(Math.random()*(m-n)+n);
		        }
		$(function(){
			$.ajax({
				type:"get",
				url:"C-mage.json",
				dataType:"json"
//				async:true

			})
			.done(function(data){
//				alert(data.suername)
				$('#com-mage').append('<tr><td>'+data.suername+'</td><td>'
				+data.ip+'</td><td>'+data.cpux+'</td><td>'+data.cpun+
				'</td><td>'+data.useS+'</td><td>'+data.inH+'</td><td>'
				+data.mb+'</td><td>'+data.yp+'</td><td>'+data.usernew+
				'</td><td>  <a href="C-add-this.html" title="部署管理" '+
				'class="fa"><span class="fa-sitemap">安装</span></a> </td></tr>')
			})




		})
		//创建一个websocket的链接
		 var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + {{ request.user.id }} + '/');

		//接收消息，并响应
		 chatSocket.onmessage = function(e) {

            var data = JSON.parse(e.data);
            var message = data['message'];

             // document.querySelector('#chat-log').value += (message+ '\n');
             //第二次循环的时候清空遍历出的行
             $(".new_line").remove()
             var teststr=''
             var rank=0
            for(i=0;i<message.length;i++){
			    //获取后端传递过来的数据
				hostowner_id=message[i].hostowner_id
				host_name=message[i].host_name
				hostip=message[i].hostip
				port=message[i].port
				username=message[i].username   //ssh用户名
				system_ver=message[i].system_ver
				ssh_status=message[i].ssh_status  //ssh远程状态
				mac_address=message[i].mac_address  //mac地址
				res_freememory=message[i].res_freememory
                res_allmemory=message[i].res_allmemory

                //判断遍历出的数据是否是user所属的远程主机
				//if(hostowner_id!={{ request.user.id }}){
				//    continue
				//}
				rank +=1;
				params=[host_name,hostip,port,username,system_ver,ssh_status,mac_address,res_freememory,res_allmemory,hostowner_id]

                //判断增加扫描出来的主机列表，添加到前端
                var divwithd=(((res_allmemory-res_freememory)/res_allmemory)*100).toFixed(2)+'%'
                var strnew=
                            `
                            <tr class="new_line">
                            	<td>${rank}</td>
                                <td>${host_name}</td>
                                <td>${hostip}</td>
                                <td>${port}</td>
                                <td>${username}</td>
                                <td>${system_ver}</td>
                                <td>${ssh_status}</td>
                                <td>${mac_address}</td>
                                <td>${res_freememory}</td>
                                <td>${res_allmemory}</td>
                                <td>


                                    <div style="height: 50px;width: 100%;border: 1px solid black">
                                        <div class="show_random" style="height: 100%;background-color: rgb(56, 156, 182); line-height: 50px; width: ${divwithd};">${divwithd}</div>
                                    </div>

                                 </td>
                                <td>
                                    <a href="{% url "user:addapp" %}" title="部署管理" class="fa">
                                        <span class="fa-sitemap">安装</span>
                                    </a> </td>
                              </tr>
                                `
                teststr+=strnew

            }

            $('#com-mage').append(teststr)


         };

		 //关闭socket，并响应
         chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
         };


	</script>


</body>
</html>
